--------------------------------------------------------------------------------
-- Removing Constratins
-- Dependency: None
--------------------------------------------------------------------------------
ALTER TABLE ALAFIA17_DIM_LOOP_SCHEDULE  DROP CONSTRAINT ALAFIA17_DIM_LOOP_SCHEDUL_FK1;
ALTER TABLE ALAFIA17_DIM_LOOP_SCHEDULE  DROP CONSTRAINT ALAFIA17_DIM_LOOP_SCHEDUL_FK2;
ALTER TABLE ALAFIA17_DIM_LOOP_SCHEDULE  DROP CONSTRAINT ALAFIA17_DIM_LOOP_SCHEDUL_FK3;
ALTER TABLE ALAFIA17_DIM_LOOP_SCHEDULE  DROP CONSTRAINT ALAFIA17_DIM_LOOP_SCHEDUL_FK4;
ALTER TABLE ALAFIA17_RACE_TIMES         DROP CONSTRAINT ALAFIA17_RACE_TIMES_FK1;
ALTER TABLE ALAFIA17_RACE_TIMES         DROP CONSTRAINT ALAFIA17_RACE_TIMES_FK2;
ALTER TABLE ALAFIA17_RACE_TIMES         DROP CONSTRAINT ALAFIA17_RACE_TIMES_FK3;
ALTER TABLE ALAFIA17_UNDER20_TIMES      DROP CONSTRAINT ALAFIA17_UNDER20_TIMES_FK1;
ALTER TABLE ALAFIA17_UNDER20_TIMES      DROP CONSTRAINT ALAFIA17_UNDER20_TIMES_FK2;
ALTER TABLE ALAFIA17_UNDER20_TIMES      DROP CONSTRAINT ALAFIA17_UNDER20_TIMES_FK3;
ALTER TABLE ALAFIA17_UNDER20_TIMES      DROP CONSTRAINT ALAFIA17_UNDER20_TIMES_FK4;
ALTER TABLE ALAFIA17_UNDER20_TIMES      DROP CONSTRAINT ALAFIA17_UNDER20_TIMES_FK5;
ALTER TABLE ALAFIA17_DIM_RUNNER         DROP CONSTRAINT ALAFIA17_DIM_RUNNER_FK1;
ALTER TABLE ALAFIA17_DIM_TEAM           DROP CONSTRAINT ALAFIA17_DIM_TEAM_PK;

--------------------------------------------------------------------------------
-- DIM_DATE
-- Creating Calendar Tables
-- Dependency: None
--------------------------------------------------------------------------------
CREATE TABLE TMP_DATES_1 AS
WITH base_calendar AS
  (SELECT CurrDate          AS Day_ID,
    1                       AS Day_Time_Span,
    CurrDate                AS Day_End_Date,
    TO_CHAR(CurrDate,'Day') AS Week_Day_Full,
    TO_CHAR(CurrDate,'DY')  AS Week_Day_Short,
    TO_NUMBER(TRIM(leading '0'
  FROM TO_CHAR(CurrDate,'D'))) AS Day_Num_of_Week,
    TO_NUMBER(TRIM(leading '0'
  FROM TO_CHAR(CurrDate,'DD'))) AS Day_Num_of_Month,
    TO_NUMBER(TRIM(leading '0'
  FROM TO_CHAR(CurrDate,'DDD'))) AS Day_Num_of_Year,
    UPPER(TO_CHAR(CurrDate,'Mon')
    || '-'
    || TO_CHAR(CurrDate,'YYYY')) AS Month_ID,
    TO_CHAR(CurrDate,'Mon')
    || ' '
    || TO_CHAR(CurrDate,'YYYY') AS Month_Short_Desc,
    RTRIM(TO_CHAR(CurrDate,'Month'))
    || ' '
    || TO_CHAR(CurrDate,'YYYY') AS Month_Long_Desc,
    TO_CHAR(CurrDate,'Mon')     AS Month_Short,
    TO_CHAR(CurrDate,'Month')   AS Month_Long,
    TO_NUMBER(TRIM(leading '0'
  FROM TO_CHAR(CurrDate,'MM'))) AS Month_Num_of_Year,
    'Q'
    || UPPER(TO_CHAR(CurrDate,'Q')
    || '-'
    || TO_CHAR(CurrDate,'YYYY'))     AS Quarter_ID,
    TO_NUMBER(TO_CHAR(CurrDate,'Q')) AS Quarter_Num_of_Year,
    CASE
      WHEN TO_NUMBER(TO_CHAR(CurrDate,'Q')) <= 2
      THEN 1
      ELSE 2
    END AS half_num_of_year,
    CASE
      WHEN TO_NUMBER(TO_CHAR(CurrDate,'Q')) <= 2
      THEN 'H'
        || 1
        || '-'
        || TO_CHAR(CurrDate,'YYYY')
      ELSE 'H'
        || 2
        || '-'
        || TO_CHAR(CurrDate,'YYYY')
    END                      AS half_of_year_id,
    TO_CHAR(CurrDate,'YYYY') AS Year_ID
  FROM
    (SELECT level n,
      -- Calendar starts at the day after this date.
      TO_DATE('7/12/2017','DD/MM/YYYY') + NUMTODSINTERVAL(level,'DAY') CurrDate
    FROM dual
      -- Change for the number of days to be added to the table.
      CONNECT BY level <= 2
    )
  )
SELECT day_id,
  day_time_span,
  day_end_date,
  week_day_full,
  week_day_short,
  day_num_of_week,
  day_num_of_month,
  day_num_of_year,
  month_id,
  COUNT(*) OVER (PARTITION BY month_id)    AS Month_Time_Span,
  MAX(day_id) OVER (PARTITION BY month_id) AS Month_End_Date,
  month_short_desc,
  month_long_desc,
  month_short,
  month_long,
  month_num_of_year,
  quarter_id,
  COUNT(*) OVER (PARTITION BY quarter_id)    AS Quarter_Time_Span,
  MAX(day_id) OVER (PARTITION BY quarter_id) AS Quarter_End_Date,
  quarter_num_of_year,
  half_num_of_year,
  half_of_year_id,
  COUNT(*) OVER (PARTITION BY half_of_year_id)    AS Half_Year_Time_Span,
  MAX(day_id) OVER (PARTITION BY half_of_year_id) AS Half_Year_End_Date,
  year_id,
  COUNT(*) OVER (PARTITION BY year_id)    AS Year_Time_Span,
  MAX(day_id) OVER (PARTITION BY year_id) AS Year_End_Date
FROM base_calendar
ORDER BY day_id;
);
COMMIT;

DROP TABLE ALAFIA17_DIM_DATE;
CREATE TABLE ALAFIA17_DIM_DATE AS
SELECT
   to_char(a.day_id, 'yyyymmdd')||TO_CHAR(to_date(n,'SSSSS'),'HH24')||TO_CHAR(to_date(n,'SSSSS'),'MI')||TO_CHAR(to_date(n,'SSSSS'),'SS') AS DATE_KEY,
   n AS time_id,
   TO_CHAR(to_date(n,'SSSSS'),'HH24') AS hour,
   TO_CHAR(to_date(n,'SSSSS'),'MI') AS minute,
   TO_CHAR(to_date(n,'SSSSS'),'SS') AS second,
   a.*
FROM (
   SELECT
      level-1 n
   FROM
      DUAL
   CONNECT BY LEVEL <= 86400
) cross join TMP_DATES_1 a
order by a.DAY_NUM_OF_YEAR, 1;
DROP TABLE TMP_DATES_1;
COMMIT;

--------------------------------------------------------------------------------
-- DIM_WEATHER
-- Creating Weather Tables
-- Dependency: ALAFIA17_WEATHER which comes from scraping wunderweather for date
--------------------------------------------------------------------------------
CREATE TABLE TMP_WEATHER_1 AS
SELECT 
    TRIM(WEATHER_DATE || ' '  || LPAD(SUBSTR(TIME,0,INSTR(TIME, ':')-1),2,'0')|| SUBSTR(TIME,LENGTH(TIME)-2)) DATE_HOUR
    , TO_NUMBER(TRIM(TEMP_F)) TEMP_F
    , TO_NUMBER(TRIM(CASE WHEN HEAT_INDEX_F = '-' THEN '' ELSE HEAT_INDEX_F END)) HEAT_INDEX_F
    , TO_NUMBER(TRIM(DEW_POINT_F)) DEW_POINT_F
    , TO_NUMBER(TRIM(HUMIDITY_PERCENT)) HUMIDITY_PERCENT
    , TO_NUMBER(TRIM(PRESSURE_IN)) PRESSURE_IN
    , TO_NUMBER(TRIM(VISIBILITY_MI)) VISIBILITY_MI
    , TRIM(WIND_DIRECTION) WIND_DIRECTION
    , TO_NUMBER(TRIM(CASE WHEN WIND_SPEED_MPH IN ('-','Calm') THEN '' ELSE WIND_SPEED_MPH END)) WIND_SPEED_MPH
    , TO_NUMBER(TRIM(CASE WHEN WIND_GUST_SPEED_MPH = '-' THEN '' ELSE WIND_GUST_SPEED_MPH END)) WIND_GUST_SPEED_MPH
    , TRIM(CASE WHEN PRECIPITATION_IN = 'N/A' THEN '' ELSE PRECIPITATION_IN END) PRECIPITATION_IN
    , TRIM(EVENTS) EVENTS
    , TRIM(CONDITIONS) CONDITIONS 
FROM ALAFIA17_WEATHER
;

DROP TABLE ALAFIA17_DIM_WEATHER;
CREATE TABLE ALAFIA17_DIM_WEATHER AS
SELECT
    '201712'||SUBSTR(DATE_HOUR,0,2)||SUBSTR(DATE_HOUR,11,2)||SUBSTR(DATE_HOUR,14,2) AS WEATHER_KEY
    , DATE_HOUR
    , AVG(TEMP_F) TEMP_F
    , TRUNC(AVG(HEAT_INDEX_F),1) HEAT_INDEX_F
    , AVG(DEW_POINT_F) DEW_POINT_F
    , TRUNC(AVG(HUMIDITY_PERCENT),1) HUMIDITY_PERCENT
    , TRUNC(AVG(PRESSURE_IN),1) PRESSURE_IN
    , TRUNC(AVG(VISIBILITY_MI),1) VISIBILITY_MI
    , MAX(WIND_DIRECTION) WIND_DIRECTION
    , TRUNC(AVG(WIND_SPEED_MPH),1) WIND_SPEED_MPH
    , TRUNC(AVG(WIND_GUST_SPEED_MPH),1) WIND_GUST_SPEED_MPH
    , TRUNC(AVG(PRECIPITATION_IN),1) PRECIPITATION_IN
    , MAX(EVENTS) EVENTS
    , MAX(CONDITIONS) CONDITIONS
FROM
    TMP_WEATHER_1
GROUP BY DATE_HOUR
ORDER BY TO_DATE(DATE_HOUR, 'DD-MON-YY HH AM')
;
DROP TABLE TMP_WEATHER_1;
COMMIT;

--------------------------------------------------------------------------------
-- 
-- Creating Race Time Tables
-- Dependency: ALAFIA17_DUMP - web scrape from alafia results page
--TODO: replace LOOP with LOOP_KEY, RUN_KEY
--------------------------------------------------------------------------------
CREATE TABLE RACE_TIMES_MID AS
SELECT RACE_NO TEAM_KEY, 01 RUN_KEY, 1 LOOP_KEY, 'LOOP_01_GREEN'   LOOP, LOOP_1_GREEN   DURATION FROM ALAFIA17_DUMP UNION
SELECT RACE_NO TEAM_KEY, 02 RUN_KEY, 2 LOOP_KEY, 'LOOP_02_YELLOW'  LOOP, LOOP_2_YELLOW  DURATION FROM ALAFIA17_DUMP UNION
SELECT RACE_NO TEAM_KEY, 03 RUN_KEY, 3 LOOP_KEY, 'LOOP_03_RED'     LOOP, LOOP_3_RED     DURATION FROM ALAFIA17_DUMP UNION
SELECT RACE_NO TEAM_KEY, 04 RUN_KEY, 1 LOOP_KEY, 'LOOP_04_GREEN'   LOOP, LOOP_4_GREEN   DURATION FROM ALAFIA17_DUMP UNION
SELECT RACE_NO TEAM_KEY, 05 RUN_KEY, 2 LOOP_KEY, 'LOOP_05_YELLOW'  LOOP, LOOP_5_YELLOW  DURATION FROM ALAFIA17_DUMP UNION
SELECT RACE_NO TEAM_KEY, 06 RUN_KEY, 3 LOOP_KEY, 'LOOP_06_RED'     LOOP, LOOP_6_RED     DURATION FROM ALAFIA17_DUMP UNION
SELECT RACE_NO TEAM_KEY, 07 RUN_KEY, 1 LOOP_KEY, 'LOOP_07_GREEN'   LOOP, LOOP_7_GREEN   DURATION FROM ALAFIA17_DUMP UNION
SELECT RACE_NO TEAM_KEY, 08 RUN_KEY, 2 LOOP_KEY, 'LOOP_08_YELLOW'  LOOP, LOOP_8_YELLOW  DURATION FROM ALAFIA17_DUMP UNION
SELECT RACE_NO TEAM_KEY, 09 RUN_KEY, 3 LOOP_KEY, 'LOOP_09_RED'     LOOP, LOOP_9_RED     DURATION FROM ALAFIA17_DUMP UNION
SELECT RACE_NO TEAM_KEY, 10 RUN_KEY, 1 LOOP_KEY, 'LOOP_10_GREEN'   LOOP, LOOP_10_GREEN  DURATION FROM ALAFIA17_DUMP UNION
SELECT RACE_NO TEAM_KEY, 11 RUN_KEY, 2 LOOP_KEY, 'LOOP_11_YELLOW'  LOOP, LOOP_11_YELLOW DURATION FROM ALAFIA17_DUMP UNION
SELECT RACE_NO TEAM_KEY, 12 RUN_KEY, 3 LOOP_KEY, 'LOOP_12_RED'     LOOP, LOOP_12_RED    DURATION FROM ALAFIA17_DUMP UNION
SELECT RACE_NO TEAM_KEY, 13 RUN_KEY, 1 LOOP_KEY, 'LOOP_13_GREEN'   LOOP, LOOP_13_GREEN  DURATION FROM ALAFIA17_DUMP UNION
SELECT RACE_NO TEAM_KEY, 14 RUN_KEY, 2 LOOP_KEY, 'LOOP_14_YELLOW'  LOOP, LOOP_14_YELLOW DURATION FROM ALAFIA17_DUMP UNION
SELECT RACE_NO TEAM_KEY, 15 RUN_KEY, 3 LOOP_KEY, 'LOOP_15_RED'     LOOP, LOOP_15_RED    DURATION FROM ALAFIA17_DUMP UNION
SELECT RACE_NO TEAM_KEY, 16 RUN_KEY, 1 LOOP_KEY, 'LOOP_16_GREEN'   LOOP, LOOP_16_GREEN  DURATION FROM ALAFIA17_DUMP UNION
SELECT RACE_NO TEAM_KEY, 17 RUN_KEY, 2 LOOP_KEY, 'LOOP_17_YELLOW'  LOOP, LOOP_17_YELLOW DURATION FROM ALAFIA17_DUMP UNION
SELECT RACE_NO TEAM_KEY, 18 RUN_KEY, 3 LOOP_KEY, 'LOOP_18_RED'     LOOP, LOOP_18_RED    DURATION FROM ALAFIA17_DUMP UNION
SELECT RACE_NO TEAM_KEY, 19 RUN_KEY, 1 LOOP_KEY, 'LOOP_19_GREEN'   LOOP, LOOP_19_GREEN  DURATION FROM ALAFIA17_DUMP UNION
SELECT RACE_NO TEAM_KEY, 20 RUN_KEY, 2 LOOP_KEY, 'LOOP_20_YELLOW'  LOOP, LOOP_20_YELLOW DURATION FROM ALAFIA17_DUMP UNION
SELECT RACE_NO TEAM_KEY, 21 RUN_KEY, 3 LOOP_KEY, 'LOOP_21_RED'     LOOP, LOOP_21_RED    DURATION FROM ALAFIA17_DUMP UNION
SELECT RACE_NO TEAM_KEY, 22 RUN_KEY, 1 LOOP_KEY, 'LOOP_22_GREEN'   LOOP, LOOP_22_GREEN  DURATION FROM ALAFIA17_DUMP UNION
SELECT RACE_NO TEAM_KEY, 23 RUN_KEY, 2 LOOP_KEY, 'LOOP_23_YELLOW'  LOOP, LOOP_23_YELLOW DURATION FROM ALAFIA17_DUMP UNION
SELECT RACE_NO TEAM_KEY, 24 RUN_KEY, 3 LOOP_KEY, 'LOOP_24_RED'     LOOP, LOOP_24_RED    DURATION FROM ALAFIA17_DUMP
;

DROP TABLE ALAFIA17_RACE_TIMES;
CREATE TABLE ALAFIA17_RACE_TIMES AS
SELECT TEAM_KEY,RUN_KEY,LOOP_KEY,LOOP,DURATION,
CASE
  WHEN SUBSTR(DURATION,0,2) < '10' THEN SUBSTR(DURATION,0,2)*60+ SUBSTR(SUBSTR(DURATION,4,LENGTH(DURATION)-3),0,2) || ':' || SUBSTR(SUBSTR(DURATION,4,LENGTH(DURATION)-3),4,2)
  WHEN LENGTH(DURATION) = 3 THEN SUBSTR(DURATION,2,2) || ':00'
  WHEN SUBSTR(DURATION,0,2) >'10' THEN SUBSTR(DURATION,1,5)
  ELSE DURATION END DURATION_AS_MINUTES
FROM RACE_TIMES_MID 
WHERE DURATION IS NOT NULL
ORDER BY TEAM_KEY,LOOP;
DROP TABLE RACE_TIMES_MID;

ALTER TABLE ALAFIA17_RACE_TIMES ADD (DURATION_AS_SECONDS VARCHAR2(50),REVISED CHAR(1));
COMMIT;

 -- Rodrigo
INSERT INTO ALAFIA17_RACE_TIMES VALUES(118,01, 1, 'LOOP_01_GREEN',	'00:55:31', '55:31','','Y'); 
INSERT INTO ALAFIA17_RACE_TIMES VALUES(118,17, 2, 'LOOP_17_YELLOW','00:55:59', '55:59','','Y');
INSERT INTO ALAFIA17_RACE_TIMES VALUES(118,09, 3, 'LOOP_09_RED',	'01:14:34', '74:34','','Y');
 -- Harry
INSERT INTO ALAFIA17_RACE_TIMES VALUES(118,10, 1, 'LOOP_10_GREEN',	'01:00:01', '60:01','','Y');
INSERT INTO ALAFIA17_RACE_TIMES VALUES(118,02, 2, 'LOOP_02_YELLOW','00:47:39', '47:39','','Y'); 
INSERT INTO ALAFIA17_RACE_TIMES VALUES(118,18, 3, 'LOOP_18_RED',	'01:11:36', '71:36','','Y');
 -- Mario
INSERT INTO ALAFIA17_RACE_TIMES VALUES(118,19, 1, 'LOOP_19_GREEN',	'00:50:12', '50:12','','Y'); 
INSERT INTO ALAFIA17_RACE_TIMES VALUES(118,11, 2, 'LOOP_11_YELLOW','00:47:50', '47:50','','Y'); 
INSERT INTO ALAFIA17_RACE_TIMES VALUES(118,03, 3, 'LOOP_03_RED',	'01:01:43', '61:43','','Y'); 
 -- Michael
INSERT INTO ALAFIA17_RACE_TIMES VALUES(118,04, 1, 'LOOP_04_GREEN',	'00:58:00', '58:00','','Y'); 
INSERT INTO ALAFIA17_RACE_TIMES VALUES(118,20, 2, 'LOOP_20_YELLOW','00:55:59', '55:59','','Y'); 
INSERT INTO ALAFIA17_RACE_TIMES VALUES(118,12, 3, 'LOOP_12_RED',	'01:19:00', '79:00','','Y'); 
 -- Wilson
INSERT INTO ALAFIA17_RACE_TIMES VALUES(118,13, 1, 'LOOP_13_GREEN',	'00:51:47', '51:47','','Y'); 
INSERT INTO ALAFIA17_RACE_TIMES VALUES(118,05, 2, 'LOOP_05_YELLOW','00:41:22', '41:22','','Y'); 
INSERT INTO ALAFIA17_RACE_TIMES VALUES(118,21, 3, 'LOOP_21_RED',	'01:11:36', '71:36','','Y'); 
 -- Raul
INSERT INTO ALAFIA17_RACE_TIMES VALUES(118,22, 1, 'LOOP_22_GREEN',	'00:50:12', '50:12','','Y'); 
INSERT INTO ALAFIA17_RACE_TIMES VALUES(118,14, 2, 'LOOP_14_YELLOW','00:41:53', '41:53','','Y'); 
INSERT INTO ALAFIA17_RACE_TIMES VALUES(118,06, 3, 'LOOP_06_RED',	'01:01:32', '61:32','','Y');
 -- Glen
INSERT INTO ALAFIA17_RACE_TIMES VALUES(118,07, 1, 'LOOP_07_GREEN',	'01:03:00', '63:00','','Y');
INSERT INTO ALAFIA17_RACE_TIMES VALUES(118,23, 2, 'LOOP_23_YELLOW','00:55:59', '55:59','','Y'); 
INSERT INTO ALAFIA17_RACE_TIMES VALUES(118,15, 3, 'LOOP_15_RED',	'01:20:00', '80:00','','Y');
 -- Jose
INSERT INTO ALAFIA17_RACE_TIMES VALUES(118,16, 1, 'LOOP_16_GREEN',	'00:50:12', '50:12','','Y'); 
INSERT INTO ALAFIA17_RACE_TIMES VALUES(118,08, 2, 'LOOP_08_YELLOW','00:40:05', '40:05','','Y'); 
INSERT INTO ALAFIA17_RACE_TIMES VALUES(118,24, 3, 'LOOP_24_RED',	'01:11:36', '71:36','','Y');

UPDATE ALAFIA17_RACE_TIMES
SET DURATION_AS_SECONDS = (SUBSTR(DURATION_AS_MINUTES,0,2)*60)+SUBSTR(DURATION_AS_MINUTES,4,2)
WHERE LENGTH(DURATION_AS_MINUTES) = 5;

UPDATE ALAFIA17_RACE_TIMES
SET DURATION_AS_SECONDS = (SUBSTR(DURATION_AS_MINUTES,0,3)*60)+SUBSTR(DURATION_AS_MINUTES,5,2)
WHERE LENGTH(DURATION_AS_MINUTES) = 6;

UPDATE ALAFIA17_RACE_TIMES
SET DURATION_AS_SECONDS = (SUBSTR(DURATION_AS_MINUTES,0,2)*60*60)+(SUBSTR(DURATION_AS_MINUTES,4,2)*60)+SUBSTR(DURATION_AS_MINUTES,7,2)
WHERE LENGTH(DURATION_AS_MINUTES) = 8;


--------------------------------------------------------------------------------
CREATE TABLE TMP_UNDER20_TIMES_1 AS
SELECT 
    c.BIB TEAM_KEY
    , b.RUN_KEY
    , b.LOOP_KEY
    , b.LOOP
    , SUBSTR(b.LOOP,6,2) RUN_NUMBER
    , CASE
        WHEN b.LOOP IN ('LOOP_01_GREEN','LOOP_17_YELLOW','LOOP_09_RED') THEN '118-1' -- Rodrigo
        WHEN b.LOOP IN ('LOOP_10_GREEN','LOOP_02_YELLOW','LOOP_18_RED') THEN '118-2' -- Harry
        WHEN b.LOOP IN ('LOOP_19_GREEN','LOOP_11_YELLOW','LOOP_03_RED') THEN '118-3' -- Mario
        WHEN b.LOOP IN ('LOOP_04_GREEN','LOOP_20_YELLOW','LOOP_12_RED') THEN '118-4' -- Michael
        WHEN b.LOOP IN ('LOOP_13_GREEN','LOOP_05_YELLOW','LOOP_21_RED') THEN '118-5' -- Wilson
        WHEN b.LOOP IN ('LOOP_22_GREEN','LOOP_14_YELLOW','LOOP_06_RED') THEN '118-6' -- Raul
        WHEN b.LOOP IN ('LOOP_07_GREEN','LOOP_23_YELLOW','LOOP_15_RED') THEN '118-7' -- Glen
        WHEN b.LOOP IN ('LOOP_16_GREEN','LOOP_08_YELLOW','LOOP_24_RED') THEN '118-8' -- Jose
        ELSE 'Unknown' END RUNNER_KEY
    , b.DURATION_AS_SECONDS
    , LAG(b.DURATION_AS_SECONDS,1) OVER(ORDER BY SUBSTR(b.LOOP,6,2)) DURATION_AS_SECONDS_PREVIOUS
    -- , SUM(LAG(b.DURATION_AS_SECONDS,1) OVER(ORDER BY SUBSTR(b.LOOP,6,2))) OVER(PARTITION BY SUBSTR(b.LOOP,6,2) ORDER BY SUBSTR(b.LOOP,6,2) RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS RUNNING_TOTAL
    , b.DURATION_AS_MINUTES
    -- , CASE         WHEN b.LOOP = 'LOOP_01_GREEN'   THEN '08-DEC-17 02:00:00 PM'         WHEN b.LOOP = 'LOOP_02_YELLOW'  THEN '08-DEC-17 02:53:32 PM'         WHEN b.LOOP = 'LOOP_03_RED'     THEN '08-DEC-17 04:01:22 PM'         WHEN b.LOOP = 'LOOP_04_GREEN'   THEN '08-DEC-17 04:59:30 PM'         WHEN b.LOOP = 'LOOP_05_YELLOW'  THEN '08-DEC-17 05:42:33 PM'         WHEN b.LOOP = 'LOOP_06_RED'     THEN '08-DEC-17 06:44:08 PM'         WHEN b.LOOP = 'LOOP_07_GREEN'   THEN '08-DEC-17 07:08:08 PM'         WHEN b.LOOP = 'LOOP_08_YELLOW'  THEN '08-DEC-17 08:11:13 PM'         WHEN b.LOOP = 'LOOP_09_RED'     THEN '08-DEC-17 08:51:23 PM'         WHEN b.LOOP = 'LOOP_10_GREEN'   THEN '08-DEC-17 10:06:09 PM'         WHEN b.LOOP = 'LOOP_11_YELLOW'  THEN '09-DEC-17 03:43:36 AM'         WHEN b.LOOP = 'LOOP_12_RED'     THEN '09-DEC-17 04:32:28 AM'         WHEN b.LOOP = 'LOOP_13_GREEN'   THEN '09-DEC-17 05:42:06 AM'         WHEN b.LOOP = 'LOOP_14_YELLOW'  THEN '09-DEC-17 06:33:42 AM'         WHEN b.LOOP = 'LOOP_15_RED'     THEN '09-DEC-17 07:15:20 AM'         WHEN b.LOOP = 'LOOP_16_GREEN'   THEN '09-DEC-17 08:35:57 AM'         WHEN b.LOOP = 'LOOP_17_YELLOW'  THEN '09-DEC-17 09:25:26 AM'         WHEN b.LOOP = 'LOOP_18_RED'     THEN '09-DEC-17 10:22:08 AM'         WHEN b.LOOP = 'LOOP_19_GREEN'   THEN '09-DEC-17 11:30:24 AM'         WHEN b.LOOP = 'LOOP_20_YELLOW'  THEN '09-DEC-17 12:19:06 PM'         WHEN b.LOOP = 'LOOP_21_RED'     THEN '09-DEC-17 01:19:10 PM'         WHEN b.LOOP = 'LOOP_22_GREEN'   THEN '09-DEC-17 02:19:14 PM'         WHEN b.LOOP = 'LOOP_23_YELLOW'  THEN '09-DEC-17 03:07:57 PM'         WHEN b.LOOP = 'LOOP_24_RED'     THEN '09-DEC-17 04:08:01 PM'         END START_TIMES
FROM 
    ALAFIA17_RACE_TIMES b 
INNER JOIN ALAFIA17_DIM_TEAM c ON b.TEAM_KEY = c.BIB AND b.TEAM_KEY = '118' AND b.REVISED = 'Y'
ORDER BY SUBSTR(b.LOOP,6,2);
COMMIT;

DROP TABLE ALAFIA17_UNDER20_TIMES;
CREATE TABLE ALAFIA17_UNDER20_TIMES AS
SELECT 
    a.TEAM_KEY
    , a.RUN_KEY
    , a.LOOP_KEY
    , a.RUNNER_KEY
--    , b.WEATHER_KEY
    , a.DURATION_AS_SECONDS
    , a.DURATION_AS_SECONDS_PREVIOUS
    , to_date(NVL(TO_CHAR(TO_DATE('08-DEC-17 02:00:00 PM','DD-MON-YY HH:MI:SS AM') + numToDSInterval(SUM(a.DURATION_AS_SECONDS_PREVIOUS) OVER( ORDER BY a.RUN_NUMBER RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW), 'second' ),'DD-MON-YY HH:MI:SS AM'),'08-DEC-17 02:00:00 PM'), 'dd-mon-yy hh:mi:ss am') START_TIME
    , a.DURATION_AS_MINUTES RACE_TIME
FROM 
    TMP_UNDER20_TIMES_1 a
--INNER JOIN  ALAFIA17_DIM_WEATHER b ON to_char(to_date(NVL(TO_CHAR(TO_DATE('08-DEC-17 02:00:00 PM','DD-MON-YY HH:MI:SS AM') + numToDSInterval(SUM(a.DURATION_AS_SECONDS_PREVIOUS) OVER( ORDER BY a.RUN_NUMBER RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW), 'second' ),'DD-MON-YY HH:MI:SS AM'),'08-DEC-17 02:00:00 PM'), 'dd-mon-yy hh:mi:ss am'), 'yyyymmddhhAM') = b.weather_key
;
DROP TABLE TMP_UNDER20_TIMES_1;

ALTER TABLE ALAFIA17_UNDER20_TIMES ADD (WEATHER_KEY VARCHAR2(30));

UPDATE  ALAFIA17_UNDER20_TIMES a
SET     WEATHER_KEY = (
SELECT b.WEATHER_KEY
FROM ALAFIA17_DIM_WEATHER b,ALAFIA17_UNDER20_TIMES a
WHERE to_char(a.start_time, 'yyyymmddhhAM') = b.WEATHER_KEY 
AND ROWNUM = 1
);
COMMIT;

--------------------------------------------------------------------------------
-- DIM_TEAM
-- Creating Team Tables
-- Dependency: ALAFIA17_DUMP - whis is scrape from rangnar results for Alafia
--------------------------------------------------------------------------------
DROP TABLE ALAFIA17_DIM_TEAM;
CREATE TABLE ALAFIA17_DIM_TEAM AS
SELECT
    RACE_NO AS TEAM_KEY
    , TYPE TYPE
    , POSITION POSITION
    , RACE_NO BIB
    , NAME NAME
    , TIME TIME
    , CATEGORY CATEGORY
    , CAT_POS CATEGORY_POSITION
    , GENDER GENDER
    , GEN_POS GENDER_POSITION
FROM ALAFIA17_DUMP ;
ALTER TABLE ALAFIA17_DIM_TEAM ADD (RUNNER1 VARCHAR2(50),RUNNER2 VARCHAR2(50),RUNNER3 VARCHAR2(50),RUNNER4 VARCHAR2(50),RUNNER5 VARCHAR2(50),RUNNER6 VARCHAR2(50),RUNNER7 VARCHAR2(50),RUNNER8 VARCHAR2(50));
UPDATE ALAFIA17_DIM_TEAM SET RUNNER1='Rodrigo', RUNNER2='Harry', RUNNER3='Mario', RUNNER4='Michael', RUNNER5='Wilson', RUNNER6='Raul', RUNNER7='Glen', RUNNER8='Jose' WHERE BIB ='118';


--------------------------------------------------------------------------------
-- DIM_LOOP
-- Creating Loops Tables
-- Dependency: None
--------------------------------------------------------------------------------
DROP TABLE ALAFIA17_DIM_LOOP;
CREATE TABLE ALAFIA17_DIM_LOOP (
	LOOP_KEY NUMBER,
	LABEL VARCHAR2(50),
	NAME VARCHAR2(50),
	DIFFICULTY VARCHAR2(50),
	ELEVATION NUMBER,
	DISTANCE NUMBER
);
INSERT INTO ALAFIA17_DIM_LOOP VALUES(1,'GREEN','Sand Pine Trail','Easy',175.62,5.5);
INSERT INTO ALAFIA17_DIM_LOOP VALUES(2,'YELLOW','Rock Garden Trail','Medium',272.42,4.3);
INSERT INTO ALAFIA17_DIM_LOOP VALUES(3,'RED','Magic Island Trail','Hard',395.14,5.6);

--------------------------------------------------------------------------------
-- DIM_RUN
-- Creating Runs Tables
-- Dependency: None
--------------------------------------------------------------------------------
DROP TABLE ALAFIA17_DIM_RUN;
CREATE TABLE ALAFIA17_DIM_RUN (RUN_KEY NUMBER(2,0));
INSERT INTO ALAFIA17_DIM_RUN VALUES(1);
INSERT INTO ALAFIA17_DIM_RUN VALUES(2);
INSERT INTO ALAFIA17_DIM_RUN VALUES(3);
INSERT INTO ALAFIA17_DIM_RUN VALUES(4);
INSERT INTO ALAFIA17_DIM_RUN VALUES(5);
INSERT INTO ALAFIA17_DIM_RUN VALUES(6);
INSERT INTO ALAFIA17_DIM_RUN VALUES(7);
INSERT INTO ALAFIA17_DIM_RUN VALUES(8);
INSERT INTO ALAFIA17_DIM_RUN VALUES(9);
INSERT INTO ALAFIA17_DIM_RUN VALUES(10);
INSERT INTO ALAFIA17_DIM_RUN VALUES(11);
INSERT INTO ALAFIA17_DIM_RUN VALUES(12);
INSERT INTO ALAFIA17_DIM_RUN VALUES(13);
INSERT INTO ALAFIA17_DIM_RUN VALUES(14);
INSERT INTO ALAFIA17_DIM_RUN VALUES(15);
INSERT INTO ALAFIA17_DIM_RUN VALUES(16);
INSERT INTO ALAFIA17_DIM_RUN VALUES(17);
INSERT INTO ALAFIA17_DIM_RUN VALUES(18);
INSERT INTO ALAFIA17_DIM_RUN VALUES(19);
INSERT INTO ALAFIA17_DIM_RUN VALUES(20);
INSERT INTO ALAFIA17_DIM_RUN VALUES(21);
INSERT INTO ALAFIA17_DIM_RUN VALUES(22);
INSERT INTO ALAFIA17_DIM_RUN VALUES(23);
INSERT INTO ALAFIA17_DIM_RUN VALUES(24);
COMMIT;

--------------------------------------------------------------------------------
-- DIM_RUNNER
-- Creating Runners Tables
-- Dependency: None
--------------------------------------------------------------------------------
DROP TABLE ALAFIA17_DIM_RUNNER;
CREATE TABLE ALAFIA17_DIM_RUNNER (
	RUNNER_KEY VARCHAR2(5),
    TEAM_KEY NUMBER,
	RUNNER_NUMBER NUMBER,
	RUNNER_NAME VARCHAR(50)
);
INSERT INTO ALAFIA17_DIM_RUNNER VALUES('118-1',118,1,'Rodrigo');
INSERT INTO ALAFIA17_DIM_RUNNER VALUES('118-2',118,2,'Harry');
INSERT INTO ALAFIA17_DIM_RUNNER VALUES('118-3',118,3,'Mario');
INSERT INTO ALAFIA17_DIM_RUNNER VALUES('118-4',118,4,'Michael');
INSERT INTO ALAFIA17_DIM_RUNNER VALUES('118-5',118,5,'Wilson');
INSERT INTO ALAFIA17_DIM_RUNNER VALUES('118-6',118,6,'Raul');
INSERT INTO ALAFIA17_DIM_RUNNER VALUES('118-7',118,7,'Glen');
INSERT INTO ALAFIA17_DIM_RUNNER VALUES('118-8',118,8,'Jose');
COMMIT;

--------------------------------------------------------------------------------
-- FACT_
-- Creating Race Tables FACTS
-- Dependency: None
--------------------------------------------------------------------------------
DROP TABLE ALAFIA17_DIM_LOOP_SCHEDULE;
CREATE TABLE ALAFIA17_DIM_LOOP_SCHEDULE (
	RUN_KEY NUMBER,
	LOOP_KEY NUMBER,
	TEAM_KEY NUMBER(5),
	RUNNER_KEY VARCHAR2(5),
    RUNNER_NUMBER NUMBER,
	TYPE VARCHAR2(50)
);

--------------------------------------------------------------------------------
---------------------------------- Race, planned -------------------------------
-- Dependency: None
--------------------------------------------------------------------------------
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(1,1,'118','118-1',1,'Planned');
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(2,2,'118','118-2',2,'Planned');
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(3,3,'118','118-3',3,'Planned');
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(4,1,'118','118-4',4,'Planned');
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(5,2,'118','118-5',5,'Planned');
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(6,3,'118','118-6',6,'Planned');
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(7,1,'118','118-7',7,'Planned');
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(8,2,'118','118-8',8,'Planned');
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(9,3,'118','118-1',1,'Planned');
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(10,1,'118','118-2',2,'Planned');
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(11,2,'118','118-3',3,'Planned');
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(12,3,'118','118-4',4,'Planned');
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(13,1,'118','118-5',5,'Planned');
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(14,2,'118','118-6',6,'Planned');
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(15,3,'118','118-7',7,'Planned');
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(16,1,'118','118-8',8,'Planned');
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(17,2,'118','118-1',1,'Planned');
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(18,3,'118','118-2',2,'Planned');
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(19,1,'118','118-3',3,'Planned');
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(20,2,'118','118-4',4,'Planned');
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(21,3,'118','118-5',5,'Planned');
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(22,1,'118','118-6',6,'Planned');
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(23,2,'118','118-7',7,'Planned');
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(24,3,'118','118-8',8,'Planned');

--------------------------------------------------------------------------------
---------------------------------- Race, revised -------------------------------
-- Dependency: None
--------------------------------------------------------------------------------
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(1, 1,'118','118-1',1,'Revised'); 
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(2, 2,'118','118-2',2,'Revised'); 
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(3, 3,'118','118-3',3,'Revised'); 
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(4, 1,'118','118-4',4,'Revised'); 
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(5, 2,'118','118-5',5,'Revised'); 
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(6, 3,'118','118-6',6,'Revised'); 
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(7, 1,'118','118-7',7,'Revised'); 
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(8, 2,'118','118-8',8,'Revised'); 
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(9, 3,'118','118-1',1,'Revised'); 
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(10,1,'118','118-2',2,'Revised'); 
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(11,2,'118','118-3',3,'Revised'); 
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(12,3,'118','118-4',4,'Revised'); 
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(13,1,'118','118-5',5,'Revised'); 
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(14,2,'118','118-6',6,'Revised'); 
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(15,3,'118','118-7',7,'Revised'); 
-- G Jose, Raul, Mario
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(16,1,'118','118-8',8,'Revised'); 
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(16,1,'118','118-3',3,'Revised'); 
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(16,1,'118','118-6',6,'Revised'); 
-- Y Glen, Michael, Rodrigo
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(17,2,'118','118-1',1,'Revised'); 
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(17,2,'118','118-4',4,'Revised'); 
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(17,2,'118','118-7',7,'Revised'); 
-- R Wilson, Harry, Jose
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(18,3,'118','118-2',2,'Revised'); 
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(18,3,'118','118-5',5,'Revised'); 
INSERT INTO ALAFIA17_DIM_LOOP_SCHEDULE VALUES(18,3,'118','118-8',8,'Revised'); 
COMMIT;

--------------------------------------------------------------------------------
---------------------------------- Keys, Constraints --------------------------- 
-- Adding constraints
-- Dependency: None
--------------------------------------------------------------------------------
ALTER TABLE ALAFIA17_DIM_DATE       MODIFY (DATE_KEY    NOT NULL);
ALTER TABLE ALAFIA17_DIM_LOOP       MODIFY (LOOP_KEY    NOT NULL);
ALTER TABLE ALAFIA17_DIM_RUN        MODIFY (RUN_KEY     NOT NULL);
ALTER TABLE ALAFIA17_DIM_RUNNER     MODIFY (RUNNER_KEY  NOT NULL);
ALTER TABLE ALAFIA17_DIM_TEAM       MODIFY (TEAM_KEY    NOT NULL);
ALTER TABLE ALAFIA17_DIM_WEATHER    MODIFY (WEATHER_KEY NOT NULL);

ALTER TABLE ALAFIA17_DIM_DATE       ADD CONSTRAINT ALAFIA17_DIM_DATE_PK     PRIMARY KEY (DATE_KEY)      ENABLE;
ALTER TABLE ALAFIA17_DIM_LOOP       ADD CONSTRAINT ALAFIA17_DIM_LOOP_PK     PRIMARY KEY (LOOP_KEY)      ENABLE;
ALTER TABLE ALAFIA17_DIM_RUN        ADD CONSTRAINT ALAFIA17_DIM_RUN_PK      PRIMARY KEY (RUN_KEY)       ENABLE;
ALTER TABLE ALAFIA17_DIM_RUNNER     ADD CONSTRAINT ALAFIA17_DIM_RUNNER_PK   PRIMARY KEY (RUNNER_KEY)    ENABLE;

ALTER TABLE ALAFIA17_DIM_TEAM           ADD CONSTRAINT ALAFIA17_DIM_TEAM_PK             PRIMARY KEY (TEAM_KEY)      ENABLE;
ALTER TABLE ALAFIA17_DIM_WEATHER        ADD CONSTRAINT ALAFIA17_DIM_WEATHER_PK          PRIMARY KEY (WEATHER_KEY)   ENABLE;
ALTER TABLE ALAFIA17_DIM_RUNNER         ADD CONSTRAINT ALAFIA17_DIM_RUNNER_FK1          FOREIGN KEY (TEAM_KEY)      REFERENCES ALAFIA17_DIM_TEAM    (TEAM_KEY)      ENABLE;
ALTER TABLE ALAFIA17_DIM_LOOP_SCHEDULE  ADD CONSTRAINT ALAFIA17_DIM_LOOP_SCHEDUL_FK1    FOREIGN KEY (RUN_KEY)       REFERENCES ALAFIA17_DIM_RUN     (RUN_KEY)       ENABLE;
ALTER TABLE ALAFIA17_DIM_LOOP_SCHEDULE  ADD CONSTRAINT ALAFIA17_DIM_LOOP_SCHEDUL_FK2    FOREIGN KEY (LOOP_KEY)      REFERENCES ALAFIA17_DIM_LOOP    (LOOP_KEY)      ENABLE;
ALTER TABLE ALAFIA17_DIM_LOOP_SCHEDULE  ADD CONSTRAINT ALAFIA17_DIM_LOOP_SCHEDUL_FK3    FOREIGN KEY (RUNNER_KEY)    REFERENCES ALAFIA17_DIM_RUNNER  (RUNNER_KEY)    ENABLE;
ALTER TABLE ALAFIA17_DIM_LOOP_SCHEDULE  ADD CONSTRAINT ALAFIA17_DIM_LOOP_SCHEDUL_FK4    FOREIGN KEY (TEAM_KEY)      REFERENCES ALAFIA17_DIM_TEAM    (TEAM_KEY)      ENABLE;

ALTER TABLE ALAFIA17_RACE_TIMES         ADD CONSTRAINT ALAFIA17_RACE_TIMES_FK1          FOREIGN KEY (TEAM_KEY)      REFERENCES ALAFIA17_DIM_TEAM    (TEAM_KEY)      ENABLE;
ALTER TABLE ALAFIA17_RACE_TIMES         ADD CONSTRAINT ALAFIA17_RACE_TIMES_FK2          FOREIGN KEY (RUN_KEY)       REFERENCES ALAFIA17_DIM_RUN     (RUN_KEY)       ENABLE;
ALTER TABLE ALAFIA17_RACE_TIMES         ADD CONSTRAINT ALAFIA17_RACE_TIMES_FK3          FOREIGN KEY (LOOP_KEY)      REFERENCES ALAFIA17_DIM_LOOP    (LOOP_KEY)      ENABLE;

ALTER TABLE ALAFIA17_UNDER20_TIMES      ADD CONSTRAINT ALAFIA17_UNDER20_TIMES_FK1       FOREIGN KEY (TEAM_KEY)      REFERENCES ALAFIA17_DIM_TEAM    (TEAM_KEY)      ENABLE;
ALTER TABLE ALAFIA17_UNDER20_TIMES      ADD CONSTRAINT ALAFIA17_UNDER20_TIMES_FK2       FOREIGN KEY (RUN_KEY)       REFERENCES ALAFIA17_DIM_RUN     (RUN_KEY)       ENABLE;
ALTER TABLE ALAFIA17_UNDER20_TIMES      ADD CONSTRAINT ALAFIA17_UNDER20_TIMES_FK3       FOREIGN KEY (LOOP_KEY)      REFERENCES ALAFIA17_DIM_LOOP    (LOOP_KEY)      ENABLE;

ALTER TABLE ALAFIA17_UNDER20_TIMES      ADD CONSTRAINT ALAFIA17_UNDER20_TIMES_FK4       FOREIGN KEY (WEATHER_KEY)   REFERENCES ALAFIA17_DIM_WEATHER (WEATHER_KEY)   ENABLE;

ALTER TABLE ALAFIA17_UNDER20_TIMES      ADD CONSTRAINT ALAFIA17_UNDER20_TIMES_FK5       FOREIGN KEY (RUNNER_KEY)    REFERENCES ALAFIA17_DIM_RUNNER  (RUNNER_KEY)    ENABLE;

COMMIT;
